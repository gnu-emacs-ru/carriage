#+title: Концепция серверов — Следующие шаги (Swarm)
#+author: Carriage Team
#+language: ru
#+options: toc:2 num:t
#+property: header-args :results silent

* Цель следующей итерации
Сделать Swarm работоспособным “по бумаге” и по факту:
- Hub даёт единый dashboard и прокси без токенов в браузере.
- Agent обязателен к запуску headless, токен обязателен, SSE работает.
- Registry — единый источник правды, атомарный, чистится, без токенов в каталоге.

* План (серия следующих патчей)
** Patch A — нормативная доводка (спеки) и “single truth”
- Согласовать и “закрыть” контракты:
  - =spec/swarm-v1.org= (инварианты, роли, MUST/MUST NOT),
  - =spec/registry-v1.org= (атомарность, stale, GC),
  - =spec/agent-http-api-v1.org= и =spec/hub-http-api-v1.org= (envelope, auth, limits).
- Убедиться, что XREF в спеках/доках не ссылается на удалённые/несуществующие файлы.

** Patch B — Hub proxy: SSE + ограничения “как в норме”
- Proxy SSE “без накопления”: bounded buffering, kill slow clients, bounded connect timeout.
- Ограничить concurrent upstream connections (hard cap).
- Нормализовать ошибки прокси в errors-v2 envelope.

** Patch C — UI (keyspec/menu): Supervisor видим, но main Emacs не блокируется
- Добавить команды Swarm в меню (start/stop agent, start/stop hub, open dashboard, cleanup stale).
- Никаких sync network вызовов в main Emacs: только spawn/таймеры/кэш.

** Patch D — тесты (интеграция, минимальный проход)
- Registry: register/read/remove/gc-stale + права токена (0600 best-effort).
- Hub: /hub/agents (из registry), минимальный smoke proxy.
- Agent: smoke load entrypoint.

** Patch E — финальная чистка наследия webd (только вперёд)
- Удалить/архивировать остаточные ссылки и устаревшие спеки (если ещё присутствуют в дереве).
- Гармонизировать имена runtime/layout: только =carriage-swarm/= и =agents/<id>/...=.

* Контекст (узкий, на следующие патчи)
#+begin_context
spec/swarm-v1.org
spec/swarm-ops-v1.org
spec/agent-http-api-v1.org
spec/hub-http-api-v1.org
spec/registry-v1.org
spec/security-v2.org
spec/errors-v2.org
spec/logging-v2.org
spec/ui-v2.org

doc/concepts/servers-concept.org
doc/concepts/servers-dialectic.org
doc/concepts/servers-next-steps.org

lisp/carriage-web.el
lisp/carriage-agent.el
lisp/carriage-hub.el
lisp/carriage-swarm-registry.el
lisp/carriage-swarm-supervisor.el
lisp/carriage-mode.el
lisp/carriage-global-mode.el
lisp/carriage-keyspec.el

test/carriage-swarm-registry-tests.el
test/carriage-agent-server-tests.el
test/carriage-hub-proxy-tests.el
#+end_context
