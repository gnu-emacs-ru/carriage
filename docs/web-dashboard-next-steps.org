#+title: Carriage Web Dashboard — Next Steps (Iterative Plan)
#+author: Carriage Team
#+language: en

Purpose
- Track the next concrete iterations to finalize a live dashboard (sessions, events, commands) and polish networking/logging.
- Each step includes acceptance criteria and risks.

Iteration A — Sessions and Card (P1)
- Implement
  - Verify /api/sessions: list shows id/title/project/mode, ctx.count, patches.count, state.phase.
  - Verify /api/session/<id>: add last report summary from cache; include ctx sources when available.
  - Optional: cache ctx/patch counts by buffer tick (short TTL) to avoid recompute.
- Accept
  - Browser shows non-empty sessions in a real project; per-session card renders fields consistently.

Iteration B — Events Bus and SSE (P1)
- Implement
  - Pub/sub bus with debounce (~50–70ms), coalesce repeated events in a single tick.
  - Events: ui/apply/report/transport; SSE filter by ?doc=<id>; heartbeat + idle prune.
- Accept
  - Front updates card/list based on live SSE without manual refresh.

Iteration C — Commands (Whitelist) (P1)
- Implement
  - /api/cmd behind carriage-web-api-commands-enabled (default: off).
  - Map: apply_last_iteration, abort, report_open, commit_{last|all}, wip, toggle {ctx|files|visible|patched|profile}.
  - Resolve doc→buffer; run via run-at-time 0 in buffer context; return ok/WEB_E_CMD/WEB_E_AUTH/404.
- Accept
  - Off→400 WEB_E_CMD; On→commands succeed or return structured errors; SSE reflects state changes.

Iteration D — Reports/Limits/Metrics (P2)
- Implement
  - /api/report/last?doc=<id>&limit=N: return summary + first N items; respect max-json-bytes with truncation counter.
  - /api/metrics: {published, truncated, clients, ts}.
- Accept
  - Streaming payloads remain small; metrics reveal activity under multiple browser tabs.

Iteration E — UX and Stability Polish
- SSE filtering: switch EventSource to /stream?doc=<id> when a single doc is selected.
- UI: token in localStorage (already), error toasts, selective DOM updates.
- Performance: cache ctx/patch counts by buffer tick; short TTL.
- Docs: extend Debugging and Testing Guide with real-world scenarios.

Networking and Logs (Finalize P0)
- Ensure favicon returns 204 No Content (no 404 noise).
- Unify auth logs: X-Auth required on API; SSE accepts header or ?token=; mask tokens in logs.
- Graceful close: keep immediate close for non-SSE (dev); consider small delay in prod if needed.

Testing Matrix (ERT + Smoke)
- ERT:
  - /: HTML + Content-Length match + Connection: close
  - /api/health (±X-Auth)
  - /api/sessions non-empty with active Carriage buffers
  - /api/session/<id> returns card with last summary
  - /api/report/last: 400 (no doc), 404 (unknown doc), 200 (limit)
  - /api/cmd: WEB_E_CMD (flag off), ok (flag on + stubbed funcs)
  - /stream: headers text/event-stream, hello + heartbeat, one “live” event on UI/apply/report
  - /api/metrics: ok with {published,truncated,clients,ts}
- Smoke (scripts/smoke-web.sh):
  - / and /api/health (+X-Auth), /stream headers, /api/metrics ok:true
  - No Content-Length mismatches; no RST on common paths

Security and Limits
- Bind loopback (127.0.0.1) by default; optional token enforced on API and SSE.
- Commands: strict whitelist; no eval; validate input schema.
- Truncate excessive JSON; do not stream heavy diffs/previews by default.
- Never log tokens in clear.

Next checkpoints
- A: sessions/card live via SSE — visible in browser; tests updated.
- B: command whitelist on (dev) — end-to-end apply/abort/report; tests updated.
- C: metrics/report limits — visible counters and smaller payloads; smoke covers /api/metrics.
