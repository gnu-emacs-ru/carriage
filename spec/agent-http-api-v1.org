#+title: Agent HTTP API v1 — Local API and SSE for a single Carriage agent
#+author: Carriage Team <dev@carriage>
#+language: en
#+options: toc:2 num:t
#+property: header-args :results silent

Meta
- Spec-ID: carriage/agent/http/v1
- Version: v1.0
- Status: stable
- Gate: ГОТОВО (ready to implement; auth-uniformity + cache-discipline + caps must be proven by tests)
- Readiness: beta (spec-pass complete; READY/ГОТОВО for implementation; conformance tests must prove auth-uniformity + cache discipline)
- Dialectic-Readiness (summary):
  - Thesis: Agent API is minimal and local; token auth is uniform; handlers are cache-only; /api/cmd is whitelist-only.
  - Antithesis (risk): Any handler doing heavy work (buffer scans, git, context builds) or any token acceptance via URL/query breaks “no stalls / no leaks”.
  - Synthesis (gate): Ready when tests prove: X-Auth on ALL endpoints incl /stream, request caps enforced, json truncation counted, SSE cap+idle-prune works, and all responses use the same envelope+codes.
- Ready-For: Token auth uniformity + envelope conformance + cache-discipline tests
- Not-Ready-For: Expanding /api/cmd beyond whitelist (until Hub proxy + registry lifecycle is stable)
- Normativity: RFC 2119 applies
- Ownership: core, transport
- Prompt-ABI: v1
- Pack-Profiles: P1-core
- Precedence: Security > Errors > Formats > Interfaces > Algorithms > UI
- RAG-Indexing: on
- Fingerprint: <auto>

Purpose
- Anchor: PURPOSE
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Define the Agent HTTP API for a single Carriage process: JSON endpoints and SSE stream,
  served on loopback with token auth and strict whitelists, answering from cached state.

Endpoints
- Anchor: IFC
- Normative: t
- Stability: stable
- Pack-Priority: P1
- All endpoints: loopback only, Content-Type: application/json; UTF-8
- Token header: X-Auth: <token> (REQUIRED for all endpoints, including /stream)
- Token transport:
  - Agents MUST NOT accept tokens via query parameters (to avoid token leaks in URLs/logs/referrers).
    - This prohibition includes SSE: /stream MAY accept only non-secret selectors (e.g., ?doc=<id>) and MUST NOT accept any auth material via query.
  - Missing/invalid token MUST yield: 401 + {"ok":false,"error":"auth required","code":"WEB_E_AUTH"}.
- GET /api/health
  - 200: {"ok":true,"data":{"version":"X.Y.Z","engine":"git|emacs","ts":<unix>}}
- GET /api/sessions
  - 200: {"ok":true,"data":[Session,...]}
- GET /api/session/<id>
  - 200: {"ok":true,"data": Session+{"apply":{"last":ReportSummary},"ctx":{"sources":{"doc":N,"gptel":N,"visible":N,"both":N}}}}
  - 404: {"ok":false,"error":"not found","code":"WEB_E_NOT_FOUND"}
- GET /api/report/last?doc=<id>&limit=<N>
  - 200: {"ok":true,"data":{"summary":ReportSummary,"items":[...<=N...]}}
  - 404: {"ok":false,"error":"not found","code":"WEB_E_NOT_FOUND"}
- POST /api/cmd
  - Input: {"cmd": "<name>", "doc": "<id>", ...args}
  - Allowed commands (whitelist):
    - "apply_last_iteration", "abort", "report_open", "commit_all", "commit_last", "wip",
      "toggle" with {"key":"ctx|files|visible|patched|profile"}
  - 200: {"ok":true} or 400/500 error envelope; unknown → WEB_E_CMD
- GET /api/metrics
  - 200: {"ok":true,"data":{
          "published": int,
          "truncated": int,
          "clients": int,
          "sessions_count": int,
          "sessions_age_ms": number|null,
          "ts": number
        }}
- GET /stream[?doc=<id>]
  - SSE events: ui|apply|report|transport|heartbeat
  - event: <type>, data: <JSON payload>, id: <seq>

Schema
- Anchor: SCHEMA
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Response envelope:
  - success: {"ok": true, "data": <payload>}
  - error:   {"ok": false, "error": "<message>", "code": "<ERR_CODE>"}
- Session (minimal):
  - {
      "id": string, "title": string, "project": string, "mode": string,
      "intent": "Ask|Code|Hybrid", "suite": "udiff|sre|aibo", "engine": "git:<policy>|emacs",
      "branch": string|null, "ctx": {"count": int}, "patches": {"count": int},
      "state": {"phase": "idle|sending|streaming|dry-run|apply|error", "tooltip": string}
    }
- ReportSummary: {"ok": int, "fail": int, "skipped": int, "total": int, "ts": string}
- Event payloads:
  - ui:        {"type":"ui","doc":"<id>","state":{...}}
  - apply:     {"type":"apply","doc":"<id>","summary":ReportSummary}
  - report:    {"type":"report","doc":"<id>","summary":ReportSummary}
  - transport: {"type":"transport","doc":"<id>","phase":"begin|streaming|complete","meta":{"model":string}}
  - heartbeat: {"type":"heartbeat","ts":number}

Security and Limits
- Anchor: SEC
- Normative: t
- Stability: stable
- Pack-Priority: P0
- Limits/caps/timeouts for the Agent are defined ONLY by Swarm FREEZE (spec/swarm-v1.org#INV) and MUST be referenced by FREEZE names in all specs/docs.
  - Specs/docs MUST NOT restate numeric limit values outside spec/swarm-v1.org#INV (exceptions: protocol vocabulary such as HTTP status codes, standard media types, and header names; plus file permission bits such as 0600).
  - Implementations MAY repeat numeric values when required by runtime constraints, but MUST remain consistent with Swarm FREEZE and SHOULD centralize them in code.
  - FREEZE names referenced by this spec: bind, sse-max-clients, json-max-bytes, request-max-bytes.
- Loopback bind (127.0.0.1) only; remote exposure forbidden by default; CORS disabled.
- Token is REQUIRED for ALL endpoints, including /stream:
  - Missing/invalid token → 401 with {"ok":false,"code":"WEB_E_AUTH"}.
- Strict whitelist for /api/cmd; arbitrary eval is forbidden.
- Cache discipline: all handlers (including /stream) MUST answer from cached state; heavy work MUST NOT run in request filters/handlers.
- Enforce request-size limit for JSON bodies (e.g., POST /api/cmd) and reject oversized bodies:
  - MUST reject with 413 (preferred) or 400, envelope code WEB_E_PAYLOAD.
- Enforce json-max-bytes for responses/events; truncate beyond cap and increment truncation metrics (WEB_W_TRUNCATED may be logged).
- Enforce SSE client caps and idle-prune:
  - On cap overflow, reject handshake with 503 and envelope code WEB_E_CAP.
- Secrets (tokens, raw prompts) MUST NOT be logged; logs are redacted/minimal (see errors-v2/sec-v2 for clipping/redaction requirements).

Performance
- Anchor: PERF
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Handlers respond from caches; no heavy scans in filters
- SSE debounced; clients capped and idle-pruned

Testing
- Anchor: TST
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Agent health OK; SSE emits events; /api/cmd whitelist; payload caps respected
