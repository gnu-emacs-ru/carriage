#+title: Document Branching and Templates v1 — Deterministic skeletons, context profiles, and action palette
#+author: Carriage Team <dev@carriage>
#+language: en
#+options: toc:2 num:t
#+property: header-args :results silent

Meta
- Spec-ID: carriage/docs/document-branching-and-templates/v1
- Version: v1.0
- Status: draft
- Normativity: RFC 2119 applies
- Ownership: architecture, ui
- Prompt-ABI: v1
- Pack-Profiles: P1-core, P2-full, P3-debug
- Precedence: Security > Errors > Formats > Interfaces > Algorithms > UI
- RAG-Indexing: on
- Fingerprint: <auto>

Purpose
- Anchor: PURPOSE
- Normative: t
- Stability: stable
- Pack-Priority: P1
- LLM-Summary: Define document-first branching with deterministic templates, explicit context profiles (P1/P3), visible provenance, and a fixed action palette; provide an Assist surface for “light” models to propose actions and context deltas without editing buffers.

Scope
- Anchor: SCOPE
- Normative: t
- Stability: stable
- Pack-Priority: P1
- In scope: template registry, placeholder language, branching transient, context profiles (P1/P3), inheritance toggles, action palette, Assist schemas, metrics.
- Out of scope: agentic autopilots, project map generation (begin_map) — future versions.

Terms
- Anchor: TERMS
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Template: deterministic generator of Org text from a pure :render function and placeholders.
- Placeholder: {{name|filter}} expansion with a strictly whitelisted filter set.
- Context Profile: P1-core (minimal) or P3-debug (extended, opt-in).
- Inheritance: explicit import of parent begin_context paths and CAR_* flags into the new document.
- Action Palette: fixed set of insertions (Plan, Step, Test, Retro, Toggle P1↔P3) shown by visible state.
- Assist: structured suggestions from a “light” model; no buffer edits without user confirmation.

Normative Requirements
- Anchor: REQ
- Normative: t
- Stability: stable
- Pack-Priority: P1
- REQ-branch-001: Template rendering MUST be deterministic and MUST NOT perform I/O, network, TRAMP, or side effects.
- REQ-branch-002: Default context profile MUST be P1-core; P3-debug MUST be opt-in and visibly indicated.
- REQ-branch-003: Inheritance of begin_context and CAR_* MUST be opt-in and visibly recorded in the document (e.g., “inherited N paths”).
- REQ-branch-004: Documents created from templates MUST record provenance: CAR_TEMPLATE_ID and CAR_TEMPLATE_VER; also record CAR_CONTEXT_PROFILE and CAR_INHERITED.
- REQ-branch-005: Action palette MUST present a fixed set of actions; visibility is a function of current document state; a model MAY rank actions but MUST NOT edit the buffer.
- REQ-branch-006: Assist responses MUST conform to schema-locked formats; invalid responses MUST NOT modify buffers.
- REQ-branch-007: P3-debug inclusions MUST show size/budget warnings; UI SHOULD offer a quick toggle back to P1.
- REQ-branch-008: Each insertion from palette or template MUST be wrapped into a single undo group.
- REQ-branch-009: Template lookup order MUST be project (./carriage/templates) → user (~/.config/carriage/templates) → built-in; earlier locations override later ones.
- REQ-branch-010: “Time-to-skeleton” SHOULD be ≤ 60 seconds on a standard project without manual clean-up.

Invariants
- Anchor: INV
- Normative: t
- Stability: stable
- Pack-Priority: P1
- INV-branch-001: Default profile is P1-core (FREEZE).
- INV-branch-002: Placeholder engine supports only a whitelisted set of names and filters (FREEZE).
- INV-branch-003: Paths included in begin_context MUST pass normalize-path and MUST NOT be remote (TRAMP) (FREEZE).
- INV-branch-004: Insertions MUST occur within a single undo-change-group (FREEZE).

Grammar/Schema
- Anchor: SCHEMA
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Template record (plist):
  - :id (symbol, REQUIRED), :version (string semver, REQUIRED)
  - :label (string, REQUIRED), :desc (string, OPTIONAL), :category (symbol, OPTIONAL: analysis|decomposition|testing|debug|design|bug|misc)
  - :when (function ctx→bool, OPTIONAL) — visibility condition
  - :render (function ctx→string, REQUIRED) — pure; no I/O/network/TRAMP/side effects
  - :after (function env→nil, OPTIONAL) — cosmetic post-actions (cursor placement)
- Placeholder format:
  - {{name|filter1|filter2}} where name ∈ {title, today, project, origin_file, origin_heading, subtree, ctx_profile, parent_context_count}
  - filter ∈ {quote, slug, trim, upper, lower}
- Render context ctx (plist):
  - :title string, :today string(ISO), :project string, :origin-file string, :origin-heading string, :subtree string
  - :ctx-profile ('p1|'p3), :parent-context (list of strings), :inherited (plist :begin-context bool :car-flags bool)
- Assist Suggest (schema):
  - list of plists {:id symbol :label string :reason string :weight number}
- Assist Context-Delta (schema):
  - plist {:add (list of strings) :remove (list of strings) :why string}
- Carriage state fields (written under #+PROPERTY: CARRIAGE_STATE):
  - CAR_TEMPLATE_ID string, CAR_TEMPLATE_VER string
  - CAR_CONTEXT_PROFILE "P1"|"P3"
  - CAR_INHERITED "BEGIN"|"FLAGS"|"BOTH"|"NONE"

Interfaces/Contracts
- Anchor: IFC
- Normative: t
- Stability: stable
- Pack-Priority: P2
- IFC-branch-001: carriage-templates (defcustom) — template registry list of records.
- IFC-branch-002: carriage-templates-render TEMPLATE-ID CTX → string — render pure text.
- IFC-branch-003: carriage-task-create-from-template TEMPLATE-ID OPTS → file
  - OPTS: :profile ('p1|'p3), :inherit-begin-context (bool), :inherit-car-flags (bool), :origin (plist/file+heading)
  - Effects: create org/NN.N-slug.org; insert skeleton; begin_context per profile; record CAR_*; fold begin_carriage; place point in “Plan”.
- IFC-branch-004: carriage-task-insert-template TEMPLATE-ID CTX → (beg . end)
- IFC-branch-005: carriage-branching-transient () — interactive UI (Template, Profile P1/P3, Inheritance toggles)
- IFC-branch-006: carriage-actions-palette () — fixed actions; visibility by doc state; single-undo inserts
- IFC-branch-007: carriage-assist-suggest CTX → list(Suggest) — schema-locked; no edits
- IFC-branch-008: carriage-assist-context-delta CTX → Context-Delta — schema-locked; apply only after user confirmation
- IFC-branch-009: carriage-context-profile-set 'p1|'p3 — switch profile; update [Ctx:N] badge
- IFC-branch-010: carriage-metrics-note KEY VALUE — lightweight metrics emission

Algorithms
- Anchor: ALG
- Normative: t
- Stability: stable
- Pack-Priority: P2
- ALG-branch-001: Branching to a new document
  - Collect origin (title, heading, subtree). Open transient (template, profile, inheritance).
  - Build ctx (:ctx-profile default 'p1; :parent-context when inherited; :inherited flags).
  - Render via registry[:render]; create file; insert begin_context per profile; record CAR_*; fold begin_carriage; move point to “Plan”.
- ALG-branch-002: Action palette
  - Determine state: has:plan/tests/ok-patches, ctx-profile, template-id.
  - Build fixed actions set; optionally call Assist Suggest to rank; render UI; on selection, perform deterministic insertion in a single undo group.
- ALG-branch-003: Assist context-delta
  - Read current begin_context; enforce profile caps; request structured delta; validate schema; show diff; apply only on confirmation.

Errors and Diagnostics
- Anchor: ERR
- Normative: t
- Stability: stable
- Pack-Priority: P1
- TEMPLATE_E_IO_ATTEMPT — attempt of I/O/network/TRAMP in :render or filters; severity=error.
- TEMPLATE_E_UNSAFE_PLACEHOLDER — unknown placeholder/filter; severity=error.
- ASSIST_E_SCHEMA — malformed Assist response; severity=warn|error; no buffer writes.
- CONTEXT_E_LIMIT — profile size/budget exceeded; severity=warn.

Security and Limits
- Anchor: SEC
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Strictly forbid eval/load/require/network/file I/O during rendering and placeholder expansion.
- normalize-path for all begin_context paths; refuse TRAMP.
- Enforce profile caps (P1 default; P3 opt-in) and warn in UI.

Performance and Asynchrony
- Anchor: PERF
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Time-to-skeleton target ≤ 60s.
- Assist calls async; schema validation fast; UI non-blocking.
- Cache context size counters where safe; invalidate on buffer/profile changes.

UI/UX
- Anchor: UI
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Transient “Branching” (C-c e n): Template, Profile (P1/P3), Inheritance (begin_context, CAR_*).
- Action palette: fixed actions [Insert Plan|Step|Test|Retro, Toggle P1↔P3]; availability by state; single-undo; keyboardable.
- [Ctx:N] badge with tooltip (sources and size); warnings on large context.

Prompt Guidance (LLM Output Contract)
- Anchor: PRM
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Assist endpoints MUST emit only schema-locked responses (lists of actions with weights; context-delta add/remove/why).
- No free-form content in Assist mode; text generation (patches/plans) remains separate tools.

Tool Contract
- Anchor: TOOL
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Assist Suggest:
  - Input: ctx snapshot; Output: list {:id :label :reason :weight}; Errors: ASSIST_E_SCHEMA.
- Assist Context-Delta:
  - Input: current begin_context; Output: {:add [] :remove [] :why}; Errors: ASSIST_E_SCHEMA, CONTEXT_E_LIMIT.

Context Packaging
- Anchor: PACK
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Profiles:
  - P1-core — minimal necessary paths; small cap; default.
  - P3-debug — extended; larger cap; explicit warning and opt-in toggle.
- Inheritance policy: off|begin_context|car_flags|both; record in CAR_INHERITED and annotate text.

Retrieval and Indexing
- Anchor: RAG
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Index PURPOSE/REQ/INV/SCHEMA/IFC/UI/PRM/TOOL.
- Chunk size target 800–1200 tokens; overlap 120; chunk ids CHK-carriage/docs/document-branching-and-templates/v1-<ANCHOR>-NN.

Precedence Rules
- Anchor: PREC
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Security > Errors > Interfaces > Algorithms > UI.

Testing and Conformance
- Anchor: TST
- Normative: t
- Stability: stable
- Pack-Priority: P1
- CHK-branch-001: Deterministic renders; no I/O/network; placeholder whitelist enforced.
- CHK-branch-002: P1 is default; P3 opt-in; [Ctx:N] visible; overflow warning appears.
- CHK-branch-003: CAR_TEMPLATE_ID/VER/PROFILE/INHERITED recorded; inherited paths deduped and annotated.
- CHK-branch-004: Assist schema validated; invalid responses do not modify buffers.
- CHK-branch-005: Palette fixed actions; visibility by state; single-undo insertion.
- CHK-branch-006: Time-to-skeleton ≤ 60 seconds.
- Traceability:
  - REQ-branch-001 → CHK-branch-001 → code: lisp/carriage-templates.el
  - REQ-branch-002 → CHK-branch-002 → code: lisp/carriage-context.el, lisp/carriage-ui.el
  - REQ-branch-004 → CHK-branch-003 → code: lisp/carriage-doc-state.el, lisp/carriage-task.el
  - REQ-branch-006 → CHK-branch-004 → code: lisp/transports/*assist*, schema validator
  - REQ-branch-008 → CHK-branch-005/006 → code: lisp/carriage-mode.el, ui/actions

Cross-References and Anchors
- Anchor: XREF
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Source of Truth:
  - spec/spec-on-specs.org
  - spec/context-integration-v2.org
  - spec/ui-v2.org
  - spec/tool-contracts-v2.org
- Code:
  - lisp/carriage-templates.el (new)
  - lisp/carriage-task.el, lisp/carriage-ui.el, lisp/carriage-keyspec.el
  - lisp/carriage-context.el, lisp/carriage-doc-state.el
  - lisp/transports/carriage-transport-gptel.el (assist)
  - test/*

Evolution
- Anchor: EVO
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Affects-Prompt: low (Assist schemas only).
- v1.1: optional begin_map (local project map) with manual refresh; stepper autopilot (confirm each step).
- v1.2: PR-template-first and ADR-first integration bridges.

