#+title: Hub HTTP API v1 — Registry, Proxy, and Unified Dashboard
#+author: Carriage Team <dev@carriage>
#+language: en
#+options: toc:2 num:t
#+property: header-args :results silent

Meta
- Spec-ID: carriage/hub/http/v1
- Version: v1.0
- Status: ГОТОВО
- Gate: ГОТОВО (ready to implement; bounded proxy + token non-leakage must be proven by tests)
- Readiness: beta (spec-pass complete; READY/ГОТОВО for implementation; tests must prove proxy boundedness: caps/timeouts/SSE)
- Dialectic-Readiness (summary):
  - Thesis: Hub is the only browser entrypoint; it proxies Agent API/SSE and injects X-Auth server-side; browser never sees tokens.
  - Antithesis (risk): SSE proxy can easily become unbounded (buffering/slow clients), and upstream caps/timeouts/counters can leak under errors.
  - Synthesis (gate): Ready when proxy has bounded connect/read timeouts, hard cap on concurrent upstream, chunk-by-chunk SSE forwarding with slow-client disconnect, and strict envelope errors without token leakage.
- Ready-For: Proxy boundedness tests (caps/timeouts/SSE forwarding) + token non-leakage checks
- Not-Ready-For: Browser-direct-to-Agent (forbidden); multi-user/remote exposure (out of scope)
- Normativity: RFC 2119 applies
- Ownership: core, ui
- Prompt-ABI: v1
- Pack-Profiles: P2-full
- Precedence: Security > Errors > Formats > Interfaces > Algorithms > UI
- RAG-Indexing: on
- Fingerprint: <auto>

Purpose
- Anchor: PURPOSE
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Define Hub endpoints to list Agents from the Registry and proxy Agent API/streams,
  injecting tokens server-side so the browser never sees Agent secrets.

Endpoints
- Anchor: IFC
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Loopback only; Content-Type: application/json; UTF-8
- Hub health:
  - GET /hub/health → 200 {"ok":true,"data":{"version":"X.Y.Z","ts":<unix>}}
  - GET /hub/metrics → 200 {"ok":true,"data":{"agents":int,"proxy_active":int,"ts":<unix>}}
- Registry:
  - GET /hub/agents → 200 {"ok":true,"data":[{"id":string,"pid":int,"bind":string,"port":int,"label":string|null,"project":string|null,"alive":bool,"last_seen":number},...]}
  - POST /hub/cleanup → 200 {"ok":true} (remove stale entries; loopback-only; optional)
- Proxy:
  - GET /hub/agent/<id>/api/health → proxied Agent /api/health
  - GET /hub/agent/<id>/api/sessions → proxied Agent /api/sessions
  - GET /hub/agent/<id>/api/session/<doc> → proxied
  - GET /hub/agent/<id>/api/report/last?doc=<doc>&limit=<N> → proxied
  - GET /hub/agent/<id>/api/metrics → proxied
  - POST /hub/agent/<id>/api/cmd → proxied (whitelist enforced by Agent)
  - GET /hub/agent/<id>/stream[?doc=<doc>] → proxied SSE (Hub forwards events)
- Static:
  - GET / → Swarm Dashboard (vanilla HTML/JS)

Security
- Anchor: SEC
- Normative: t
- Stability: stable
- Pack-Priority: P0
- Hub binds loopback; CORS disabled
- Browser MUST NOT receive Agent tokens (never in HTML/JS/JSON/headers); Hub injects X-Auth server-side when proxying.
- Token handling:
  - Hub MAY read agents/<id>/token runtime files to proxy requests.
  - Main Emacs MUST NOT read token files (or expose tokens) in the baseline Swarm model.
- No arbitrary eval anywhere; Agents enforce whitelist

Performance
- Anchor: PERF
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Limits/caps/timeouts for the Hub are defined ONLY by Swarm FREEZE (spec/swarm-v1.org#INV) and MUST be referenced by FREEZE names in all specs/docs.
  - Specs/docs MUST NOT restate numeric limit values outside spec/swarm-v1.org#INV (exceptions: protocol vocabulary such as HTTP status codes, standard media types, and header names; plus file permission bits such as 0600).
  - Implementations MAY repeat numeric values when required by runtime constraints, but MUST remain consistent with Swarm FREEZE and SHOULD centralize them in code.
  - FREEZE names referenced by this spec: bind, proxy-max-upstream, proxy-connect-timeout-sec, proxy-read-timeout-sec, probe-interval-sec, probe-timeout-sec, probe-max-per-interval.
- Hub proxy is non-blocking; timeouts, caps, and bounded buffering are enforced:
  - Proxy GET/POST MUST have bounded connect timeout and bounded read timeout (see swarm FREEZE:
    proxy-connect-timeout-sec, proxy-read-timeout-sec).
  - Proxy SSE MUST NOT accumulate unbounded data.
    - Forwarding MUST be chunk-by-chunk (raw bytes) as they arrive from the Agent upstream; Hub MUST NOT parse, rebuffer, or “repackage” SSE.
    - Hub MUST treat downstream backpressure as a fault condition: if the browser client cannot accept data promptly, Hub MUST disconnect that browser client rather than buffering unboundedly.
    - Hub MUST enforce a bounded “slow client” rule:
      - If downstream write repeatedly fails or stalls for longer than Swarm FREEZE proxy-read-timeout-sec, Hub MUST close the downstream connection.
      - Hub MUST also close upstream (Agent) when the downstream client is gone, to avoid leaking proxy_active slots.
  - Hub MUST enforce max concurrent proxy upstream connections (see swarm FREEZE proxy-max-upstream);
    on overflow reject with 503 + {"ok":false,"code":"WEB_E_CAP"}.
- Registry reads are O(1) per listing; cleanup is batched and bounded (no unbounded scans in request handlers).
- Hub MUST NOT leak Agent tokens to the browser; token injection happens server-side only.
- Errors MUST be structured envelopes and MUST avoid secret leakage; long strings MUST be clipped (errors-v2).

Testing
- Anchor: TST
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Hub lists agents from Registry; stale entries removed
- Proxy works for API and SSE; browser never receives tokens
