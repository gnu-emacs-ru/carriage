#+title: Keyspec v3 — Bindings-first (universal keymaps + optional menu)
#+author: Carriage Team
#+language: en
#+options: toc:2 num:t
#+property: header-args :results silent

Meta
- Spec-ID: carriage/ui/keyspec/v3
- Version: v3.0
- Status: draft
- Normativity: RFC 2119 applies
- Ownership: ui, keyspec
- Prompt-ABI: v1
- Pack-Profiles: P0-min, P1-core, P2-full, P3-debug
- Precedence: Security > Errors > Formats > Interfaces > Algorithms > UI
- RAG-Indexing: on
- Fingerprint: <auto>

Purpose
- Anchor: PURPOSE
- Normative: t
- Stability: stable
- Pack-Priority: P1
- LLM-Summary:
  - Keyspec is the single source of truth for key bindings.
  - Bindings are compiled into real Emacs keymaps (prefix maps, minor-mode maps, global-map).
  - Menu UI (transient/hydra/completing-read) is optional and must not affect bindings.

Scope
- Anchor: SCOPE
- Normative: t
- Stability: stable
- Pack-Priority: P1
- In scope:
  - keyspec data model (actions/bindings/prefixes)
  - compilation into keymaps
  - menu provider abstraction (UI layer)
  - invariants for prefix vs menu
- Out of scope:
  - transport/engine internals
  - non-Carriage global key remaps outside Carriage prefixes

Terms
- Anchor: TERMS
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Action: named command entry (id → interactive function) with label/section metadata.
- Binding: mapping from a concrete key sequence to an Action, in a target keymap.
- Prefix map: a keymap bound under a prefix key sequence (e.g., "C-c e") to host suffixes.
- Menu provider: UI backend that shows a palette of Actions and invokes the chosen command.

Normative Requirements
- Anchor: REQ
- Normative: t
- Stability: stable
- Pack-Priority: P0

REQ-keys-001 (Single source):
- All user-visible key bindings MUST be declared in keyspec and compiled from it.
- Other modules MUST NOT define ad-hoc `define-key` bindings for user-visible keys.

REQ-keys-002 (Bindings-first):
- Key bindings MUST be expressed as keymap bindings (not as transient-only keys).

REQ-keys-003 (Prefix map invariant):
- The primary prefix (default "C-c e") MUST be bound to a prefix keymap (never a menu command).

REQ-keys-004 (Menu is optional):
- Menu UI MUST be callable from the prefix map, but MUST be fully optional.
- Disabling menu UI MUST NOT affect any bindings.

REQ-keys-005 (Canonical menu/help keys):
- The prefix map MUST include:
  - "SPC" → open menu
  - "?"   → show help/cheatsheet

REQ-keys-006 (Direct bindings independent of menu):
- Direct bindings (example: "C-c C-c", "C-c !") MUST work regardless of menu provider state.

REQ-keys-007 (Provider abstraction):
- Keyspect MUST allow switching menu provider (transient/hydra/completing-read/disabled)
  without changing bindings and without changing keyspec data.

Data Model
- Anchor: SCHEMA
- Normative: t
- Stability: stable
- Pack-Priority: P1

Action (plist):
- :id (symbol) unique
- :cmd (symbol) interactive command
- :section (symbol) optional, for menu grouping (navigate/act/session/tools/logs/context)
- :desc-key (symbol) optional i18n key for label
- :label (string) optional label fallback
- :contexts (list of symbol) optional, context filtering for menu/installation

Binding (plist):
- :key (string) key sequence in `kbd` syntax
- :cmd (symbol) interactive command
- :target (symbol) keymap variable (e.g., carriage-mode-map) or `global-map`
- :contexts (list of symbol) optional, for install-time filtering (e.g., global-only)
- :when (function) optional predicate for conditional installs (discouraged; use contexts)

Prefix binding:
- Primary prefix key sequence(s) (base + aliases) MUST be configurable.
- Prefixes are always installed as keymap bindings:
  prefix-seq → carriage-prefix-map

Interfaces / Contracts
- Anchor: IFC
- Normative: t
- Stability: stable
- Pack-Priority: P1

IFC-keys-001: carriage-keys-install-known-keymaps
- Effect:
  - build/update `carriage-prefix-map`
  - bind configured prefixes in Carriage-owned mode maps (carriage-mode-map, report-mode-map, …)
  - install direct bindings in those maps

IFC-keys-002: carriage-keys-global-enable / carriage-keys-global-disable
- Effect:
  - bind/unbind configured prefixes in `global-map`
  - MUST restore overwritten bindings on disable

IFC-keys-003: carriage-menu-open / carriage-menu-help
- Menu/help commands are normal Actions, bound inside prefix-map.
- When menu provider is disabled/unavailable, MUST fallback gracefully or show a message.

IFC-keys-004: Menu provider API (internal, abstract)
- Input: a list of Action objects (id/cmd/label/section).
- Output: invoke selected Action command, or return selection.
- Implementations: transient/hydra/completing-read/disabled.

Algorithms
- Anchor: ALG
- Normative: t
- Stability: stable
- Pack-Priority: P2

ALG-keys-001 (Compile prefix map):
- Clear prefix map bindings.
- Install suffix bindings into `carriage-prefix-map`.

ALG-keys-002 (Install bindings):
- For each target keymap:
  - bind each configured prefix to the prefix map
  - bind direct bindings (outside prefix map)

ALG-keys-003 (Menu dispatch):
- Based on menu provider:
  - transient/hydra if available
  - fallback to completing-read
  - disabled → message

Errors and Diagnostics
- Anchor: ERR
- Normative: t
- Stability: stable
- Pack-Priority: P2
- KEYS_E_BAD_SPEC: malformed action/binding definition; MUST NOT break unrelated bindings.
- Menu provider errors MUST NOT affect keymap bindings.

Performance
- Anchor: PERF
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Keymap installation SHOULD be O(n) in number of bindings/actions.
- Menu UI MUST NOT affect redisplay performance.

Testing and Conformance
- Anchor: TST
- Normative: t
- Stability: stable
- Pack-Priority: P2

TST-keys-001:
- prefix map is present and contains SPC/? bindings.

TST-keys-002:
- direct bindings (C-c C-c, C-c !) are present in `carriage-mode-map`.

TST-keys-003:
- with menu provider disabled, direct/prefix bindings still work; menu-open shows message/fallback.

Cross-References
- spec/context-menu-keys-v2.org
- spec/i18n-required-keys-v2.org
- spec/ui-v2.org
- Code: lisp/carriage-keyspec.el
