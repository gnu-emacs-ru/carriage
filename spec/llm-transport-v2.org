#+title: LLM Transport v2 — Streaming, events, and tool-use ABI
#+author: Peter Kosov <11111000000@email.com>
#+language: en
#+options: toc:2 num:t
#+property: header-args :results silent

Meta
- Spec-ID: carriage/transport/llm/v2
- Version: v2.0
- Status: draft
- Normativity: RFC 2119 applies
- Ownership: transports
- Prompt-ABI: v1
- Pack-Profiles: P0-min, P1-core, P2-full, P3-debug
- Precedence: Security > Errors > Formats > Interfaces > Algorithms > UI
- RAG-Indexing: on
- Fingerprint: <auto>

Purpose
- Anchor: PURPOSE
- Normative: t
- Stability: stable
- Pack-Priority: P0
- LLM-Summary: Define transport-agnostic streaming API and event model for LLMs.
  - Begin/stream/complete lifecycle
  - Reasoning and text channels
  - Abort semantics
  - Tool-call envelope
  - Error mapping and logging

Scope
- Anchor: SCOPE
- Normative: t
- Stability: stable
- Pack-Priority: P0
- In scope: event taxonomy, API, tool-use envelope, reasoning channel.
- Out of scope: vendor-specific SDK details.

Terms
- Anchor: TERMS
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Event: structured notification (begin, chunk, reasoning, done, error).
- Tool-use: explicit call to a tool with typed arguments.

Normative Requirements
- Anchor: REQ
- Normative: t
- Stability: stable
- Pack-Priority: P0
- REQ-tr-001: Transport MUST expose carriage-transport-begin/streaming/complete APIs.
- REQ-tr-002: Events MUST be delivered in order; channels include :text, :reasoning.
- REQ-tr-003: Abort MUST stop streaming and deliver a terminal completion event.
- REQ-tr-004: Tool calls MUST carry name, version, args schema, and correlation id.
- REQ-tr-005: Errors MUST map to ERR codes with vendor payload preserved as details.
- REQ-tr-006: Transport MUST record metrics per observability (pid, elapsed-ms, usage),
  and produce traffic summaries (head/tail/bytes).
- REQ-tr-007: Streaming adapters MAY emit combined reasoning+text chunks; clients MUST handle both combined and separate forms.
- REQ-tr-009: Terminal completion (done|error|abort) MUST provide token usage summary when available,
  in a transport-agnostic schema suitable for pricing and fingerprint upsert. Missing usage MUST be allowed.

Invariants
- Anchor: INV
- Normative: t
- Stability: stable
- Pack-Priority: P0
- INV-tr-001: Exactly one terminal event per request (done|error|abort).
- INV-tr-002: Reasoning channel is optional and may be truncated for UI.

Grammar/Schema
- Anchor: SCHEMA
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Event (plist):
  - :type one of (begin chunk reasoning tool-call done error abort)
  - :id string, :ts number, :payload plist
- Usage (plist, optional; present on terminal events when available):
  - :tokens-in integer|nil
  - :tokens-out integer|nil
  - :audio-in integer|nil
  - :audio-out integer|nil
  - :raw any|nil (vendor payload preserved for diagnostics; must not affect UI logic)
- Tool-call (plist):
  - :name string, :ver string, :args plist, :corr-id string

Interfaces/Contracts
- Anchor: IFC
- Normative: t
- Stability: stable
- Pack-Priority: P1
- IFC-tr-001: carriage-transport-begin CTX → token
- IFC-tr-002: carriage-transport-streaming token chunk
- IFC-tr-003: carriage-transport-complete token status
- IFC-tr-004: Abort handler on token MUST be idempotent

Algorithms
- Anchor: ALG
- Normative: t
- Stability: stable
- Pack-Priority: P1
- ALG-tr-001: Marshal events to UI on main thread; coalesce small chunks.
- ALG-tr-002: On abort, cancel vendor stream and emit terminal state.

Errors and Diagnostics
- Anchor: ERR
- Normative: t
- Stability: stable
- Pack-Priority: P0
- ERR-tr-001: TR_E_ABORT — user abort
- ERR-tr-002: TR_E_STREAM — vendor streaming error
- ERR-tr-003: TR_E_TOOL — tool invocation failure

Security and Limits
- Anchor: SEC
- Normative: t
- Stability: stable
- Pack-Priority: P0
- Sanitize tool arguments; mask secrets in logs; rate-limit retries.

Performance and Asynchrony
- Anchor: PERF
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Batching for tokens; backpressure handling; timeouts per event loop tick.

UI/UX
- Anchor: UI
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Distinct rendering for reasoning vs user text; progress indicators.

Prompt Guidance
- Anchor: PRM
- Normative: t
- Stability: stable
- Pack-Priority: P0
- PRM-tr-001: Tool-call outputs MUST be machine-formatted; no extra prose.
- PRM-tr-002: Output-Format: ONLY JSON or Elisp plist for any tool-call or event envelope.
  Fields: :type (enum), :id (string), :ts (number), :payload (plist). No Markdown fences.
- PRM-tr-003: Forbidden-Phrases: "Here is", "As an AI", greetings, apologies, ``` fences.
  No additional commentary or headers around machine payloads.
- PRM-tr-004: Determinism Window: T=0, top_p=1.0 for tests; permitted variance: :ts only.
  All other fields MUST be byte-stable in T=0 runs.
- PRM-tr-005: Escape Policy: UTF-8 strings; escape quotes; no newlines unless a field explicitly
  allows them; no zero-width characters; normalize whitespace.
- Positive Example (JSON):
  {"type":"done","id":"req-123","ts":171234.5,"payload":{"status":"ok","usage":{"tokens":123}}}
- Negative Example (violates PRM-tr-003):
  Here is your result:
  {"type":"done","id":"req-123","ts":171234.5,"payload":{"status":"ok"}}

Tool Contract
- Anchor: TOOL
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Tools declare JSON/plist schemas; invalid args MUST produce structured ERR.

Context Packaging
- Anchor: PACK
- Normative: t
- Stability: stable
- Pack-Priority: P0
- P0-min:
  - include: carriage/transport/llm/v2#REQ priority=P0 max-tokens=700 summarize=off

Retrieval and Indexing
- Anchor: RAG
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Index normative sections; chunk ids CHK-carriage/transport/llm/v2-REQ-01..NN.

Precedence Rules
- Anchor: PREC
- Normative: t
- Stability: stable
- Pack-Priority: P0
- Security and Errors take precedence over transport claims.

Testing and Conformance
- Anchor: TST
- Normative: t
- Stability: stable
- Pack-Priority: P0
- TST-tr-001: single terminal event delivered
- TST-tr-002: abort cancels vendor stream; idempotent
- TST-tr-003: reasoning channel starts/ends correctly; no duplicate end
- TST-tr-004: callbacks marshalled to main thread; ordering preserved
- TST-tr-005: streaming → UI state transitions sending→streaming→done/error
- TST-tr-006: tool-call envelope validated (name, ver, args, corr-id); roundtrip logged
- TST-tr-007: event schema conformance (type/id/ts/payload); malformed fields rejected
- TST-tr-008: observability metrics recorded (elapsed-ms, model-id, token-usage); summaries logged
- Traceability Map:
  - REQ-tr-001 → TST-tr-005
  - REQ-tr-002 → TST-tr-003, TST-tr-004, TST-tr-007
  - REQ-tr-003 → TST-tr-002
  - REQ-tr-004 → TST-tr-006 (and TOOL tests)
  - REQ-tr-005 → TST-tr-001..007
  - REQ-tr-006 → TST-tr-008

Cross-References and Anchors
- Anchor: XREF
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Source of Truth:
  - spec/spec-on-specs.org#TOOL
  - spec/errors-v2.org#ERR
- Related:
  - spec/logging-v2.org
  - spec/observability-v2.org
- Code:
  - lisp/transports/carriage-transport.el
  - lisp/transports/carriage-transport-gptel.el
  - lisp/transports/carriage-transport-echo.el

Evolution
- Anchor: EVO
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Affects-Prompt: high (tool envelope and output contracts)
