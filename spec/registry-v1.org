#+title: Registry v1 — Runtime inventory of Carriage Agents
#+author: Carriage Team <dev@carriage>
#+language: en
#+options: toc:2 num:t
#+property: header-args :results silent

Meta
- Spec-ID: carriage/registry/v1
- Version: v1.0
- Status: stable
- Gate: ГОТОВО (ready to implement; atomic rewrite + bounded stale/GC must be proven by tests)
- Readiness: beta (spec-pass complete; READY/ГОТОВО for implementation; tests must prove atomic rewrite + bounded stale/GC)
- Dialectic-Readiness (summary):
  - Thesis: Registry is the single source of truth for discovery; per-agent runtime dirs contain pid/port/token/meta; catalog is atomically rewritten.
  - Antithesis (risk): Concurrent writers and partial crashes can corrupt inventory unless atomic rewrite is absolute and missing dirs/files are tolerated.
  - Synthesis (gate): Ready when tests prove atomic rewrite (no partial writes), safe tolerance for missing per-agent files, and deterministic bounded stale detection/GC consistent with Hub-owned liveness.
- Ready-For: Atomic rewrite + runtime layout + GC-by-pid tests
- Not-Ready-For: Complex concurrent writers without an explicit lock protocol (not required for v1)
- Normativity: RFC 2119 applies
- Ownership: core
- Prompt-ABI: v1
- Pack-Profiles: P1-core
- Precedence: Security > Errors > Formats > Interfaces > Algorithms > UI
- RAG-Indexing: on
- Fingerprint: <auto>

Purpose
- Anchor: PURPOSE
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Define a file-based registry for live Carriage Agents: per-agent runtime directories
  and a global NDJSON index. Enable Hub to discover and monitor Agents reliably.

Layout
- Anchor: LAYOUT
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Base dir: $XDG_RUNTIME_DIR/carriage-swarm/ or /tmp/carriage-swarm-$USER/
- Files and dirs:
  - registry.ndjson     ; atomically rewritten index (temp file + rename; no partial writes; append FORBIDDEN)
  - agents/<id>/pid     ; PID of agent process
  - agents/<id>/port    ; HTTP port bound by agent
  - agents/<id>/token   ; shared secret for agent API (mode 0600), not exposed to browsers
  - agents/<id>/meta.json ; {"bind":"127.0.0.1","started_ts":<unix>,"project":string|null,"label":string|null,"version":string}

Record
- Anchor: RECORD
- Normative: t
- Stability: stable
- Pack-Priority: P2
- NDJSON line schema (one per agent):
  - {
      "id": string, "pid": int, "bind": "127.0.0.1", "port": int,
      "runtime_dir": string, "meta": {"project":string|null,"label":string|null,"version":string},
      "started_ts": number, "last_seen_ts": number|null, "alive": bool|null
    }

Operations
- Anchor: OPS
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Registration:
  - Agent creates agents/<id>/, writes pid/port/token/meta.json.
  - Agent writes registry.ndjson ONLY via atomic rewrite (write temp → fsync when available → rename).
- Update:
  - Hub SHOULD own liveness: it updates last_seen_ts and alive flag via bounded health probes and atomic rewrite.
  - Liveness probes MUST be bounded (timeouts + max-per-interval) and MUST NOT perform unbounded scans.
- Cleanup:
  - Stale detection MUST be bounded and deterministic (Hub-owned):
    - PID missing/invalid OR PID not alive (best-effort) ⇒ mark alive=false immediately.
    - PID alive but health probe fails ⇒ mark alive=false only after bounded failure budget:
      - Probe uses bounded timeout (see Swarm FREEZE probe-timeout-sec).
      - Probe attempts per tick MUST be capped (see Swarm FREEZE probe-max-per-interval; Hub spec defines scheduling via probe-interval-sec).
      - Retries/backoff MUST be bounded (no unbounded exponential loops).
    - When an entry is marked alive=false, Hub MUST still keep the catalog consistent via atomic rewrite.
  - GC MAY remove dead entries and agent dirs; GC MUST be safe under concurrent agents (atomic rename; tolerate missing dirs).
  - Registry operations MUST tolerate missing per-agent dirs/files and partial process termination.

Security
- Anchor: SEC
- Normative: t
- Stability: stable
- Pack-Priority: P0
- Registry format and liveness ownership MUST be treated as the single source of truth for Swarm discovery (see spec/swarm-v1.org and spec/swarm-ops-v1.org); parallel inventory formats are forbidden.
- Any discovery/limits-related constants referenced by Registry MUST be defined ONLY via Swarm FREEZE names (spec/swarm-v1.org#INV).
  - Specs/docs MUST NOT restate numeric limit values outside spec/swarm-v1.org#INV (exceptions: protocol vocabulary such as HTTP status codes, standard media types, and header names; plus file permission bits such as 0600).
  - Implementations MAY repeat numeric values when required by runtime constraints, but MUST remain consistent with Swarm FREEZE and SHOULD centralize them in code.
- token file must be 0600; never printed in logs
- registry.ndjson must not contain raw tokens; token references via path/hash only

Testing
- Anchor: TST
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Create agent entry; Hub discovers it
- Kill agent; Hub marks stale and removes entry
- Concurrent updates do not corrupt registry.ndjson (atomic rename)
