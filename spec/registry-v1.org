#+title: Registry v1 — Runtime inventory of Carriage Agents
#+author: Carriage Team <dev@carriage>
#+language: en
#+options: toc:2 num:t
#+property: header-args :results silent

Meta
- Spec-ID: carriage/registry/v1
- Version: v1.0
- Status: draft
- Readiness: alpha
- Ready-For: Atomic rewrite + runtime layout + GC-by-pid tests
- Not-Ready-For: Complex concurrent writers without an explicit lock protocol (not required for v1)
- Normativity: RFC 2119 applies
- Ownership: core
- Prompt-ABI: v1
- Pack-Profiles: P1-core
- Precedence: Security > Errors > Formats > Interfaces > Algorithms > UI
- RAG-Indexing: on
- Fingerprint: <auto>

Purpose
- Anchor: PURPOSE
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Define a file-based registry for live Carriage Agents: per-agent runtime directories
  and a global NDJSON index. Enable Hub to discover and monitor Agents reliably.

Layout
- Anchor: LAYOUT
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Base dir: $XDG_RUNTIME_DIR/carriage-swarm/ or /tmp/carriage-swarm-$USER/
- Files and dirs:
  - registry.ndjson     ; atomically rewritten index (temp file + rename; no partial writes; append FORBIDDEN)
  - agents/<id>/pid     ; PID of agent process
  - agents/<id>/port    ; HTTP port bound by agent
  - agents/<id>/token   ; shared secret for agent API (mode 0600), not exposed to browsers
  - agents/<id>/meta.json ; {"bind":"127.0.0.1","started_ts":<unix>,"project":string|null,"label":string|null,"version":string}

Record
- Anchor: RECORD
- Normative: t
- Stability: stable
- Pack-Priority: P2
- NDJSON line schema (one per agent):
  - {
      "id": string, "pid": int, "bind": "127.0.0.1", "port": int,
      "runtime_dir": string, "meta": {"project":string|null,"label":string|null,"version":string},
      "started_ts": number, "last_seen_ts": number|null, "alive": bool|null
    }

Operations
- Anchor: OPS
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Registration:
  - Agent creates agents/<id>/, writes pid/port/token/meta.json.
  - Agent writes registry.ndjson ONLY via atomic rewrite (write temp → fsync when available → rename).
- Update:
  - Hub SHOULD own liveness: it updates last_seen_ts and alive flag via bounded health probes and atomic rewrite.
  - Liveness probes MUST be bounded (timeouts + max-per-interval) and MUST NOT perform unbounded scans.
- Cleanup:
  - Stale detection is bounded and deterministic:
    - missing PID OR repeated health failures (bounded retries/backoff) → mark alive=false.
  - GC MAY remove dead entries and agent dirs; GC MUST be safe under concurrent agents (atomic rename; tolerate missing dirs).
  - Registry operations MUST tolerate missing per-agent dirs/files and partial process termination.

Security
- Anchor: SEC
- Normative: t
- Stability: stable
- Pack-Priority: P0
- Registry format and liveness ownership MUST be treated as the single source of truth for Swarm discovery (see spec/swarm-v1.org and spec/swarm-ops-v1.org); parallel inventory formats are forbidden.
- Any discovery/limits-related constants referenced by Registry MUST be defined ONLY via Swarm FREEZE names (spec/swarm-v1.org#INV).
  - Specs/docs MUST reference FREEZE *names* (not numbers) and MUST NOT restate Swarm limit numbers outside spec/swarm-v1.org.
  - Implementations MAY repeat numbers when required by runtime constraints, but MUST remain consistent with Swarm FREEZE and SHOULD centralize them in code.
- token file must be 0600; never printed in logs
- registry.ndjson must not contain raw tokens; token references via path/hash only

Testing
- Anchor: TST
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Create agent entry; Hub discovers it
- Kill agent; Hub marks stale and removes entry
- Concurrent updates do not corrupt registry.ndjson (atomic rename)
