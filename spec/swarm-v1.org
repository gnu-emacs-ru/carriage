#+title: Carriage Swarm v1 — Agents, Hub, and the Registry
#+author: Carriage Team <dev@carriage>
#+language: en
#+options: toc:2 num:t
#+property: header-args :results silent

Meta
- Spec-ID: carriage/swarm/v1
- Version: v1.0
- Status: draft
- Normativity: RFC 2119 applies
- Ownership: core, ui, transport
- Prompt-ABI: v1
- Pack-Profiles: P1-core
- Precedence: Security > Errors > Formats > Interfaces > Algorithms > UI
- RAG-Indexing: on
- Fingerprint: <auto>

Purpose
- Anchor: PURPOSE
- Normative: t
- Stability: stable
- Pack-Priority: P0
- LLM-Summary: Define a resilient “swarm” architecture for Carriage: multiple independent Agents
  (headless Emacs processes) each hosting Carriage and a local HTTP/SSE server; a Hub process
  aggregates, proxies, and presents a unified web dashboard; a Registry persists live agent
  entries. Main Emacs does not host HTTP.

Scope
- Anchor: SCOPE
- Normative: t
- Stability: stable
- Pack-Priority: P0
- In scope:
  - Agent role: serve local API/stream for a single Carriage session
  - Hub role: proxy to agents, present unified web UI, list agents
  - Registry: file-based inventory of live agents (pid/port/token/meta)
  - Security, limits, lifecycle and health checks
- Out of scope: remote exposure beyond loopback; multi-user ACL; arbitrary eval

Terms
- Anchor: TERMS
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Agent: standalone Emacs process with Carriage and a local HTTP/SSE server.
- Hub: standalone Emacs process that reads Registry and proxies API/streams to Agents.
- Registry: file-based index of live Agents (runtime dir entries + NDJSON).
- Session: logical unit of observation (one Carriage buffer/file inside an Agent).
- Token: shared secret for Agent API, carried as X-Auth (Hub injects; browser never sees it).

Normative Requirements
- Anchor: REQ
- Normative: t
- Stability: stable
- Pack-Priority: P0
- REQ-swarm-001: Agents and Hub MUST bind to loopback (127.0.0.1) by default; CORS MUST be disabled.
- REQ-swarm-002: Main Emacs MUST NOT host HTTP/SSE servers. Only Agents and Hub serve HTTP/SSE.
- REQ-swarm-003: Agents MUST expose local API and SSE; handlers MUST answer from cached state; heavy
  work MUST be performed by idle timers or internal publishers, not in process filters.
- REQ-swarm-004: Hub MUST proxy browser requests to Agents (API and SSE). Browser MUST NOT receive
  Agent tokens; Hub injects X-Auth on behalf of the browser.
- REQ-swarm-005: All command endpoints MUST implement a strict whitelist; arbitrary eval is forbidden.
- REQ-swarm-006: Payload size limits and truncation MUST be enforced consistently across Agents and Hub.
- REQ-swarm-007: Agents SHOULD select port=0 by default (ephemeral); per-Agent runtime directories MUST
  be unique to avoid collisions.
- REQ-swarm-008: Registry entries MUST be written atomically; stale entries MUST be detected and cleaned.
- REQ-swarm-009: SSE MUST be the baseline streaming protocol; reconnects MUST be tolerated; idle clients pruned.
- REQ-swarm-010: Errors MUST map to errors-v2 with structured envelopes; severity preserved (no secret leakage; clip long strings).
- REQ-swarm-011: Browser clients MUST talk to the Hub only; browser direct-to-Agent access is forbidden in the baseline Swarm model.
- REQ-swarm-012: Hub SHOULD own liveness: it performs bounded health probes and updates Registry last_seen/alive via atomic rewrite.
- REQ-swarm-013: Hub proxy MUST be bounded: connect/read timeouts, max concurrent upstream, and bounded buffering (especially for SSE).

Invariants
- Anchor: INV
- Normative: t
- Stability: stable
- Pack-Priority: P1
- FREEZE values in this section are the single source of truth for Swarm limits/caps/timeouts.
  - Specs/docs MUST reference FREEZE *names* (not numbers) and MUST NOT restate Swarm limit numbers anywhere outside this FREEZE list.
    - Exception: protocol vocabulary (HTTP status codes, header names, standard media types) and file permission bits (e.g., 0600) may be stated where required.
  - Implementations MAY repeat numeric values when required by runtime constraints, but MUST remain consistent with Swarm FREEZE and SHOULD centralize them in code.
- FREEZE: bind = 127.0.0.1
- FREEZE: sse-max-clients = 16
- FREEZE: json-max-bytes = 131072
- FREEZE: request-max-bytes = 2097152
- FREEZE: proxy-max-upstream = 32
- FREEZE: proxy-connect-timeout-sec = 0.5
- FREEZE: proxy-read-timeout-sec = 2.0
- INV-swarm-001: Agents and Hub MUST never block UI on network I/O; all HTTP/SSE I/O runs via non-blocking filters and timers.
- INV-swarm-002: No heavy artifacts (patch bodies, large diffs) are streamed by default; details are fetched on demand.

Interfaces/Contracts
- Anchor: IFC
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Components:
  - Agent HTTP API: health, sessions, session/<id>, report/last, cmd (whitelist), metrics, stream
  - Hub HTTP API: list agents, proxy agent API/stream, hub health/metrics, static dashboard
  - Registry format: NDJSON catalog + per-agent runtime dir with pid/port/token/meta
- Response envelope:
  - success: {"ok": true, "data": <payload>}
  - error:   {"ok": false, "error": "<message>", "code": "<ERR_CODE>"}

Security and Limits
- Anchor: SEC
- Normative: t
- Stability: stable
- Pack-Priority: P0
- Loopback bind; tokens required for Agent API and SSE
- Hub proxies tokens; browser does not see Agent tokens
- No arbitrary eval; whitelist commands only
- Payload caps and truncation; no secret leakage in logs

Performance and Asynchrony
- Anchor: PERF
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Agents and Hub MUST respond from cached state; no heavy scans in handlers
- SSE fan-out MUST be debounced; clients capped and pruned
- Registry operations MUST be atomic; health probes MUST be non-blocking and bounded

Testing and Conformance
- Anchor: TST
- Readiness (dialectic snapshot):
  - Thesis (strong): Swarm architecture is specified as a clean separation of responsibilities:
    Agent serves local API/SSE; Hub proxies and injects tokens; Registry is discovery; Main Emacs orchestrates processes only.
  - Antithesis (risk): Any ambiguity around ownership (liveness), proxy boundedness (SSE), and error envelopes will reintroduce coupling and hidden blocking paths.
  - Synthesis (what must be true to be “single source of truth”):
    - All caps/timeouts/limits in specs MUST be referenced by Swarm FREEZE *names* (spec/swarm-v1.org#INV) and MUST NOT be restated numerically elsewhere (except protocol vocabulary and file permission bits).
    - Agent endpoints MUST uniformly enforce X-Auth (including /stream); Hub MUST ensure browser never sees tokens; Registry catalog MUST never contain tokens.
    - Hub proxy MUST be fully bounded: connect/read timeouts, concurrent upstream cap, and SSE forwarding without unbounded buffering.
    - Error envelopes MUST be consistent (errors-v2) and secret-safe (no token leakage; clipped strings).
  - Practical readiness checklist (for implementation + tests):
    - CHK: Agent auth on ALL endpoints, including /stream → 401 WEB_E_AUTH.
    - CHK: Hub injects X-Auth server-side; tokens never appear in Hub responses.
    - CHK: Registry writes are atomic and append is forbidden; stale handling is bounded/deterministic.
    - CHK: Hub proxy caps/timeouts are enforced with no counter leaks on early exits.
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Compliance Checklist (minimum):
  - CHK-swarm-001: Agents and Hub bind loopback (127.0.0.1); CORS disabled; no remote bind by default.
  - CHK-swarm-002: Main Emacs MUST NOT host HTTP/SSE servers (agents/hub only).
  - CHK-swarm-003: Agent requires token (X-Auth) for ALL endpoints including /stream; missing/invalid → WEB_E_AUTH.
  - CHK-swarm-004: Hub proxies Agent API/SSE and injects X-Auth; browser never receives Agent tokens.
  - CHK-swarm-005: /api/cmd is whitelist-only; unknown/disallowed → WEB_E_CMD; no arbitrary eval anywhere.
  - CHK-swarm-006: Payload caps enforced; truncation counted/exposed; oversized requests rejected.
  - CHK-swarm-007: Registry is atomic and self-healing: stale entries detected (pid/health) and cleaned.
  - CHK-swarm-008: SSE reconnects tolerated; clients capped and idle-pruned; hub forwards SSE without blocking.
- Test Matrix (integration; web processes only):
  - TST-swarm-001: Start Agent → registry entry appears → Agent /api/health OK (token enforced).
  - TST-swarm-002: Agent /api/sessions returns cached snapshot (O(1) handler); snapshot updates do not block handlers.
  - TST-swarm-003: Agent /stream emits hello + heartbeat + ui/apply/report/transport; reconnect works.
  - TST-swarm-004: Start Hub → /hub/agents lists registry entries; stale cleanup marks/removes dead agents.
  - TST-swarm-005: Hub proxies Agent /api/* and /stream; browser never sees token; proxy timeouts are bounded.

Cross-References and Anchors
- Anchor: XREF
- Normative: t
- Stability: stable
- Pack-Priority: P1
- Replaces: spec/web-dashboard-v1.org, spec/webd-ops-v1.org
- Related:
  - spec/security-v2.org
  - spec/logging-v2.org
- Code (target):
  - lisp/carriage-agent.el
  - lisp/carriage-hub.el
  - lisp/carriage-swarm-registry.el
  - lisp/carriage-swarm-supervisor.el
  - lisp/carriage-web.el (agent server role)
  - lisp/carriage-logging.el
  - lisp/carriage-mode.el, lisp/carriage-global-mode.el

Evolution
- Anchor: EVO
- Normative: t
- Stability: stable
- Pack-Priority: P2
- Affects-Prompt: none
- Future v1.x:
  - Agent sharding policies; richer Hub dashboards; per-agent TLS via UDS proxy
