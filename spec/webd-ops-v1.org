#+title: Carriage Web Daemon (webd) Operations v1

Status: deprecated
Owner: Carriage

1. Purpose
- Define operational model and supervisor commands for running the Carriage web server as a separate Emacs process (webd).
- Elisp-only solution: the main Emacs does not host HTTP/SSE; webd does.

2. Operational invariants
- HTTP/SSE server runs exclusively in a separate Emacs process (webd).
- All HTTP handlers respond from caches (O(1)); no heavy scans in request filters.
- State flows from the main Emacs to webd via a private push API (loopback + token).

3. Supervisor commands (Elisp, main Emacs)
- `carriage-webd-start`: Spawn and supervise the `webd` process.
- `carriage-webd-stop`: Stop the `webd` process.
- `carriage-webd-restart`: Restart the `webd` process.
- `carriage-webd-status`: Report pid/live/port and probe health.
- `carriage-webd-tail-log`: Show live stdout log buffer.
- `carriage-webd-tail-errors`: Show live stderr log buffer.
- `carriage-webd-kill-stale`: Clean up stale PID/PORT files from crashed daemons.
- `carriage-webd-copy-token`: Copy the current auth token to the kill-ring.
- `carriage-webd-open-dashboard`: Open the web dashboard in a browser.
- `carriage-webd-drop-sse-clients`: Command `webd` to disconnect all SSE clients.

4. Runtime files (in XDG_RUNTIME_DIR or /tmp)
- carriage-webd.pid: OS PID of the child Emacs
- carriage-webd.port: current listening port for HTTP
- carriage-webd.token: shared secret for /api/push

5. Private push API (served by webd)
- POST /api/push (loopback only, requires X-Auth: <token>)
  - body: JSON {"type":"ui|apply|report|transport|snapshot", "payload":{...}}
  - errors:
    - 401 WEB_E_PUSH_AUTH when missing/invalid token
    - 400 WEB_E_PAYLOAD for malformed/oversized payload

6. Health and metrics
- GET /api/health: 200 OK when server accepts requests
- GET /api/metrics: JSON counters for published/truncated/clients etc.

7. Testing and conformance
- Integration tests MUST run against webd (external Emacs process).
- Unit tests for HTTP parsing/JSON truncation remain pure Elisp without sockets.
- Push → cache → SSE fan-out MUST be covered by tests.
- Roadmap (dialectic plan):
  - Security/auth hardening:
    - Enforce loopback bind, X-Auth on /api/push and restricted /api/cmd; no token in logs.
    - Strict Content-Type=application/json and request-size limits; map violations to WEB_E_PAYLOAD.
  - Cache and O(1) handlers:
    - In daemon (webd) mode all GET/SSE handlers answer ONLY from caches; no buffer scans in filters.
    - Snapshot population via /api/push (type="snapshot") and periodic idle publisher in the main Emacs.
  - Publish pipeline:
    - Main Emacs publishes ui/apply/report/transport and snapshot via short HTTP POST /api/push (fire-and-forget, short timeouts).
    - Fallback to local path is deprecated; tests and docs reflect webd-only operation.
  - Supervisor lifecycle:
    - Start → wait health (short backoff) → switch publish-backend to 'push → seed initial snapshot.
    - Stop/kill-stale clean PID/PORT files; Status prints pid/alive/bind/port/health.
  - HTML/JS:
    - Periodically fetch /api/metrics; refresh sessions on "snapshot" SSE event.
  - CI and gating:
    - Gate integration tests with webd; keep pure Elisp unit tests socket-free.
    - Add checks for /api/push (ok/401/400), sessions from cache, SSE hello, metrics types.
  - Migration:
    - Remove in-process HTTP/SSE paths from production; keep only for limited unit scenarios if needed.
    - Update specs and docs to reflect webd-only mode as the single supported path.
  - Observability:
    - Ensure metrics include published/truncated/clients/sessions_count/sessions_age_ms and, when applicable, rejected_by_cap.
  - Cross-platform:
    - Verify supervisor behavior on non-POSIX (signals fallback); ensure runtime dir logic degrades gracefully.

8. Migration notes
- In-process HTTP/SSE in the main Emacs is forbidden.
- Main Emacs publishes events and snapshots via /api/push only.
- Web dashboard polling frequency can be reduced; SSE events provide freshness.

9. Security
- /api/push requires loopback bind and a strong token (not logged).
- Enforce Content-Length limits; reject oversized bodies with 413/400.
